# Letter Matrix Portal

A lightweight Express + TypeScript service that takes placeholder values from a simple web form, merges them into an exported HTML letter template, and emails the finished PDF back to the author.

## Quick start

1. **Install dependencies**
   ```bash
   npm install
   ```
2. **Configure environment variables**
   - Duplicate `.env.example` (or create `.env`) with the following keys:
     - `RESEND_API_KEY` – API key from [Resend](https://resend.com/) for email delivery.
     - `EMAIL_FROM` – Verified sender address (e.g. `figmaletter@tinkertanker.com`).
     - `TEMPLATE` – Name of the Word template (without extension) placed in `templates/`.
3. **Provide your template**
   - Export your Word document as filtered HTML (`File → Save As → Web Page, Filtered`).
   - Drop the generated `<TEMPLATE>.html` file (and its accompanying asset folder) into `templates/`.
   - Keep the placeholder token `<<name>>` where you want the recipient’s name to appear.
4. **Run the development server**
   ```bash
   npm run dev
   ```
   The app listens on [http://localhost:3000](http://localhost:3000) by default.
5. **Generate a PDF**
   - Open the portal in your browser.
   - Provide the recipient’s name and email user ID (everything before `@tinkertanker.com`).
   - Hit “Generate PDF” to email the merged document—`<<name>>` will be replaced automatically.

## Scripts

- `npm run dev` – Start the Express server with live TypeScript reloading via `tsx`.
- `npm run build` – Type-check and emit JavaScript into `dist/`.
- `npm start` – Run the compiled server (after `npm run build`).
- `npm test` – Placeholder; feel free to swap for your preferred test command.

## How it works

1. **Templating** – The backend loads the exported HTML, swaps in the submitted name for `<<name>>`, and stitches in local assets with a `<base>` tag.
2. **Rendering** – The HTML is rendered directly to PDF by a headless Chromium instance supplied by Puppeteer, preserving the visual layout from Word.
3. **Delivery** – The PDF is emailed via Resend to `<user>@tinkertanker.com` using the configured sender.

## Operational notes

- The first PDF generation spins up Chromium; expect the initial request to take a little longer while the browser warms up.
- `templates/<TEMPLATE>.html` is cached after the first read. Replace the file and restart the server to refresh the cache.
- If Puppeteer struggles to launch on your platform, set the `PUPPETEER_EXECUTABLE_PATH` environment variable to a locally installed Chromium/Chrome binary before starting the server.
- The front end lets authors add or remove placeholder rows so they can align perfectly with whichever game-specific copy they fancy.

## Troubleshooting

- **Template missing** – You will see a “Template file not found” message if the configured HTML template is absent. Double-check the location (including the asset folder) and name, then restart the server.
- **Rendering errors** – Docxtemplater throws descriptive validation errors when it encounters malformed placeholders (e.g. `{{#loops}}` without an `{{/loops}}`). Those bubble back to the browser so writers can adjust the Word template.
- **Email delivery** – If emails fail to send, confirm that `RESEND_API_KEY` and `EMAIL_FROM` are present in `.env`, and that the sender is verified in Resend.
- **Chromium download** – `npm install` downloads a compatible Chromium build automatically. If your network blocks that, fetch the binary manually and point Puppeteer at it using `PUPPETEER_EXECUTABLE_PATH`.

## Folder structure

```
letter-maker/
├── public/              # Static assets powering the HTML form
├── src/
│   ├── services/
│   │   └── matrix.ts    # Core merge + conversion logic
│   └── server.ts        # Express bootstrap and routes
├── templates/
│   ├── <template>.html  # Exported HTML template (not committed)
│   └── <template>.fld/  # Asset folder generated by Word (not committed)
├── types/               # Ambient type declarations
└── README.md
```

Ho say bo? If all that sounds good, you are ready to let the matrix crank out letters on demand.
